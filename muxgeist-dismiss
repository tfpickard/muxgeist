#!/bin/bash

# Muxgeist dismissal script
# This script completely removes the Muxgeist pane

set -e

MUXGEIST_PANE_TITLE="muxgeist"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_error() {
    echo -e "${RED}❌ $1${NC}" >&2
}

log_success() {
    echo -e "${GREEN}✅ $1${NC}" >&2
}

log_info() {
    echo -e "${YELLOW}👋 $1${NC}" >&2
}

# Check if we're in tmux
if [ -z "$TMUX" ]; then
    log_error "Must be run from within tmux"
    exit 1
fi

# Get current session and window
CURRENT_SESSION=$(tmux display-message -p '#{session_name}')
CURRENT_WINDOW=$(tmux display-message -p '#{window_index}')

# Find Muxgeist pane
find_muxgeist_pane() {
    tmux list-panes -t "$CURRENT_SESSION:$CURRENT_WINDOW" -F '#{pane_index} #{pane_title}' |
        grep "$MUXGEIST_PANE_TITLE" |
        cut -d' ' -f1
}

# Main dismissal logic
main() {
    local pane_id=$(find_muxgeist_pane)

    if [ -z "$pane_id" ]; then
        log_info "No Muxgeist pane found"
        exit 0
    fi

    log_info "Dismissing Muxgeist..."

    # Kill the pane
    tmux kill-pane -t "$pane_id"

    # Focus on the main pane (usually pane 0)
    tmux select-pane -t 0 2>/dev/null || true

    log_success "Muxgeist dismissed"
}

# Handle command line arguments
case "${1:-}" in
--force | -f)
    # Force kill all panes with muxgeist title
    tmux list-panes -a -F '#{session_name}:#{window_index}.#{pane_index} #{pane_title}' |
        grep "$MUXGEIST_PANE_TITLE" |
        cut -d' ' -f1 |
        while read pane; do
            tmux kill-pane -t "$pane" 2>/dev/null || true
        done
    log_success "All Muxgeist panes dismissed"
    ;;
--help | -h)
    echo "Muxgeist Dismissal Script"
    echo ""
    echo "Usage: $0 [option]"
    echo ""
    echo "Options:"
    echo "  (no args)   Dismiss Muxgeist from current window"
    echo "  --force     Dismiss all Muxgeist panes from all windows"
    echo "  --help      Show this help"
    ;;
"")
    main
    ;;
*)
    log_error "Unknown option: $1"
    echo "Use --help for usage information"
    exit 1
    ;;
esac
